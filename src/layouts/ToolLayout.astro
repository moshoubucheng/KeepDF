---
import BaseLayout from './BaseLayout.astro';
import PrivacyBadge from '@components/layout/PrivacyBadge.astro';
import type { ToolCategory } from '@types/tool';
import type { Locale } from '../i18n/locales';
import { localePath } from '../i18n/locales';
import { getCategoryMeta } from '@lib/utils/toolRegistry';
import { t } from '../i18n/utils';

interface Props {
  title: string;
  toolName: string;
  description?: string;
  category: ToolCategory;
  jsonLd?: Record<string, unknown>;
  lang: Locale;
}

const { title, toolName, description, category, jsonLd, lang } = Astro.props;
const cat = getCategoryMeta(lang, category);
const homeHref = localePath('/', lang);
const homeLabel = t(lang).breadcrumb.home;

const siteOrigin = 'https://keepdf.com';

// Build BreadcrumbList
const breadcrumbList: Record<string, unknown> = {
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: homeLabel, item: `${siteOrigin}${homeHref}` },
    ...(cat ? [{ '@type': 'ListItem', position: 2, name: cat.name, item: `${siteOrigin}${cat.path}` }] : []),
    { '@type': 'ListItem', position: 3, name: toolName },
  ],
};

// Wrap incoming jsonLd (WebApplication) in @graph with BreadcrumbList
const enhancedJsonLd = jsonLd ? {
  '@context': 'https://schema.org',
  '@graph': [
    Object.fromEntries(Object.entries(jsonLd).filter(([k]) => k !== '@context')),
    breadcrumbList,
  ],
} : undefined;

// Auto-compute OG image path
// Tool pages: /pdf/merge (en), /ja/pdf/merge (ja), /zh/image/compress (zh)
// OG images: /og/{locale}/{category}-{slug}.png
const pathParts = Astro.url.pathname.replace(/\/$/, '').split('/').filter(Boolean);
const isLocalePrefixed = pathParts.length >= 3;
const toolCategory = isLocalePrefixed ? pathParts[1] : pathParts[0];
const toolSlug = isLocalePrefixed ? pathParts[2] : pathParts[1];
const ogImage = `${siteOrigin}/og/${lang}/${toolCategory}-${toolSlug}.png`;
---

<BaseLayout title={title} description={description} lang={lang} ogImage={ogImage}>
  {enhancedJsonLd && (
    <script type="application/ld+json" set:html={JSON.stringify(enhancedJsonLd)} slot="head" />
  )}

  <div class="mx-auto max-w-4xl px-4 py-8">
    <!-- Breadcrumb -->
    <nav class="mb-6 text-sm text-fg-muted" aria-label="Breadcrumb">
      <ol class="flex items-center gap-1.5">
        <li><a href={homeHref} class="hover:text-brand-600">{homeLabel}</a></li>
        <li>/</li>
        {cat && (
          <>
            <li><a href={cat.path} class="hover:text-brand-600">{cat.name}</a></li>
            <li>/</li>
          </>
        )}
        <li class="text-fg font-medium">{toolName}</li>
      </ol>
    </nav>

    <!-- Tool header -->
    <div class="mb-8 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <h1 class="text-2xl font-bold text-fg">{toolName}</h1>
      <PrivacyBadge lang={lang} />
    </div>

    <!-- Tool content (React island slot) -->
    <slot />
  </div>
</BaseLayout>
